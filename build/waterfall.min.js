/*! waterfall - v0.1.0 - 2013-05-25
* http://wlog.cn/waterfall/
* Copyright (c) 2013 bingdian; Licensed MIT */
(function(t,e,i,s){"use strict";function n(e,i){this.$element=t(e),this.options=t.extend(!0,{},r,i),this.colHeightArray=[],this.styleQueue=[],this._init()}var a=t(e),o="waterfall",r={itemCls:"waterfall-item",prefix:"waterfall",fitWidth:!0,colWidth:240,gutterWidth:0,gutterHeight:0,align:"center",minCol:1,maxCol:s,maxPage:s,bufferPixel:-50,containerStyle:{position:"relative"},resizable:!0,isFadeIn:!1,isAnimated:!1,animationOptions:{},isAutoPrefill:!0,checkImagesLoaded:!0,path:s,dataType:"json",params:{},loadingMsg:'<div style="text-align:center;padding:10px 0; color:#999;"><img src="data:image/gif;base64,R0lGODlhEAALAPQAAP///zMzM+Li4tra2u7u7jk5OTMzM1hYWJubm4CAgMjIyE9PT29vb6KiooODg8vLy1JSUjc3N3Jycuvr6+Dg4Pb29mBgYOPj4/X19cXFxbOzs9XV1fHx8TMzMzMzMzMzMyH5BAkLAAAAIf4aQ3JlYXRlZCB3aXRoIGFqYXhsb2FkLmluZm8AIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAALAAAFLSAgjmRpnqSgCuLKAq5AEIM4zDVw03ve27ifDgfkEYe04kDIDC5zrtYKRa2WQgAh+QQJCwAAACwAAAAAEAALAAAFJGBhGAVgnqhpHIeRvsDawqns0qeN5+y967tYLyicBYE7EYkYAgAh+QQJCwAAACwAAAAAEAALAAAFNiAgjothLOOIJAkiGgxjpGKiKMkbz7SN6zIawJcDwIK9W/HISxGBzdHTuBNOmcJVCyoUlk7CEAAh+QQJCwAAACwAAAAAEAALAAAFNSAgjqQIRRFUAo3jNGIkSdHqPI8Tz3V55zuaDacDyIQ+YrBH+hWPzJFzOQQaeavWi7oqnVIhACH5BAkLAAAALAAAAAAQAAsAAAUyICCOZGme1rJY5kRRk7hI0mJSVUXJtF3iOl7tltsBZsNfUegjAY3I5sgFY55KqdX1GgIAIfkECQsAAAAsAAAAABAACwAABTcgII5kaZ4kcV2EqLJipmnZhWGXaOOitm2aXQ4g7P2Ct2ER4AMul00kj5g0Al8tADY2y6C+4FIIACH5BAkLAAAALAAAAAAQAAsAAAUvICCOZGme5ERRk6iy7qpyHCVStA3gNa/7txxwlwv2isSacYUc+l4tADQGQ1mvpBAAIfkECQsAAAAsAAAAABAACwAABS8gII5kaZ7kRFGTqLLuqnIcJVK0DeA1r/u3HHCXC/aKxJpxhRz6Xi0ANAZDWa+kEAA7" alt=""><br />Loading...</div>',state:{isDuringAjax:!1,isProcessingData:!1,isResizing:!1,curPage:1},callbacks:{loadingStart:function(t){t.show()},loadingFinished:function(t,e){e?t.remove():t.fadeOut()},loadingError:function(t){t.html("Data load faild, please try again later.")},renderData:function(e,i){var s,n;return"json"===i||"jsonp"===i?(s=t("#waterfall-tpl").html(),n=Handlebars.compile(s),n(e)):e}},debug:!0};n.prototype={constructor:"Waterfall",_debug:function(){!0===this.options.debug&&("undefined"!=typeof console&&"function"==typeof console.log?1===Array.prototype.slice.call(arguments).length&&"string"==typeof Array.prototype.slice.call(arguments)[0]?console.log(""+Array.prototype.slice.call(arguments)):console.log(Array.prototype.slice.call(arguments)):Function.prototype.bind||"undefined"==typeof console||"object"!=typeof console.log||Function.prototype.call.call(console.log,console,Array.prototype.slice.call(arguments)))},_init:function(t){var e=this.options,i=e.path;return this._setColumns(),this._initContainer(),this._resetColumnsHeightArray(),this.reLayout(t),i?(e.isAutoPrefill&&this._prefill(),e.resizable&&this._doResize(),this._doScroll(),s):(this._debug("Invalid path"),s)},_initContainer:function(){var e=this.options,i=e.prefix;this.$element.css(this.options.containerStyle).addClass(i+"-container"),this.$element.after('<div id="'+i+'-loading">'+e.loadingMsg+'</div><div id="'+i+'-message" style="text-align:center;color:#999;"></div>'),this.$loading=t("#"+i+"-loading"),this.$message=t("#"+i+"-message")},_getColumns:function(){var t=this.options,e=t.fitWidth?this.$element.parent():this.$element,i="BODY"===e[0].tagName?e.width()-20:e.width(),s=t.colWidth,n=t.gutterWidth,a=t.minCol,o=t.maxCol,r=Math.floor(i/(s+n)),l=Math.max(r,a);return o?l:l>o?o:l},_setColumns:function(){this.cols=this._getColumns()},_getItems:function(t){var e=t.filter("."+this.options.itemCls).css({position:"absolute"});return e},_resetColumnsHeightArray:function(){var t,e=this.cols;for(this.colHeightArray.length=e,t=0;e>t;t++)this.colHeightArray[t]=0},layout:function(t,e){var i,s,n,a,o,r,l=this.options,h=this.options.isFadeIn?this._getItems(t).css({opacity:0}).animate({opacity:1}):this._getItems(t),A=this.options.isAnimated&&this.options.state.isResizing?"animate":"css",c=l.animationOptions,u=l.colWidth,g=l.gutterWidth,d=this.colHeightArray.length,p=l.align;for(this.$element.append(h),"center"===p?(i=(this.$element.width()-(u+g)*d)/2,i=i>0?i:0):"left"===p?i=0:"right"===p&&(i=this.$element.width()-(u+g)*d),n=0,o=h.length;o>n;n++)this._placeItems(h[n],i);for(a=0,r=this.styleQueue.length;r>a;a++)s=this.styleQueue[a],s.$el[A](s.style,c);this.$element.height(Math.max.apply({},this.colHeightArray)),this.styleQueue=[],this.options.state.isResizing=!1,this.options.state.isProcessingData=!1,e&&e.call(h)},reLayout:function(t){var e=this.$element.find("."+this.options.itemCls);this._resetColumnsHeightArray(),this.layout(e,t)},_placeItems:function(e,i){var s,n,a=t(e),o=this.options,r=o.colWidth,l=o.gutterWidth,h=o.gutterHeight,A=this.colHeightArray,c=A.length,u=Math.min.apply({},A),g=t.inArray(u,A);s=a.hasClass(o.prefix+"-item-fixed-left")?0:a.hasClass(o.prefix+"-item-fixed-right")?c>1?c-1:0:g,n={left:(r+l)*s+i,top:A[s]},this.styleQueue.push({$el:a,style:n}),A[s]+=a.outerHeight()+h,a.attr("data-col",s)},prepend:function(t,e){this.$element.prepend(t),this.reLayout(e)},append:function(t,e){this.$element.append(t),this.layout(t,e)},removeItems:function(t,e){this.$element.find(t).remove(),this.reLayout(e)},option:function(e,i){t.isPlainObject(e)&&(this.options=t.extend(!0,this.options,e),i&&i(),this._init())},_requestData:function(e){var i,n=this,a=this.options,o=a.maxPage,r=a.state.curPage++,l=a.path,h=a.dataType,A=a.params;return o!==s&&r>o?(a.state.isBeyondMaxPage=!0,a.callbacks.loadingFinished(this.$loading,a.state.isBeyondMaxPage),s):(i="function"==typeof l?l(r):l.join(r),this._debug("heading into ajax",i+t.param(A)),a.callbacks.loadingStart(this.$loading),a.state.isDuringAjax=!0,a.state.isProcessingData=!0,t.ajax({url:i,data:A,dataType:h,success:function(t,i,a){var o=a.isResolved!==s?a.isResolved():"success"===i||"notmodified"===i;o?n._handleResponse(t,e):n._responeseError("end"),n.options.state.isDuringAjax=!1},error:function(){n._responeseError("error")}}),s)},_handleResponse:function(e,i){var s=this,n=this.options,a=t.trim(n.callbacks.renderData(e,n.dataType)),o=t(a),r=n.checkImagesLoaded;r?o.imagesLoaded(function(){s.append(o,i),s.options.callbacks.loadingFinished(s.$loading,s.options.state.isBeyondMaxPage)}):(s.append(o,i),s.options.callbacks.loadingFinished(s.$loading,s.options.state.isBeyondMaxPage))},_responeseError:function(t){this.$loading.hide(),this.options.callbacks.loadingError(this.$message,t),"end"!==t&&"error"!==t&&(t="unknown"),this._debug("Error",t)},_nearbottom:function(){var t=this.options,e=Math.min.apply({},this.colHeightArray),i=a.scrollTop()+a.height()-this.$element.offset().top-e;return this._debug("math:",i),i>t.bufferPixel},_prefill:function(){this.$element.height()<=a.height()&&this._scroll()},_scroll:function(){var t=this.options,e=t.state,i=this;e.isProcessingData||e.isDuringAjax||e.isInvalidPage||this._nearbottom()&&this._requestData(function(){setTimeout(function(){i._scroll()},100)})},_doScroll:function(){var t,e=this;a.bind("scroll",function(){clearTimeout(t),t=setTimeout(function(){e._debug("event","scrolling ..."),e._scroll()},100)})},_resize:function(){var t=this.cols,e=this._getColumns();(e!==t||"left"!==this.options.align)&&(this._debug("event","resizing ..."),this.options.state.isResizing=!0,this.cols=e,this.reLayout(),this._prefill())},_doResize:function(){var t,e=this;a.bind("resize",function(){clearTimeout(t),t=setTimeout(function(){e._resize()},100)})}},t.fn[o]=function(e){if("string"==typeof e){var i=Array.prototype.slice.call(arguments,1);this.each(function(){var n=t.data(this,"plugin_"+o);return n?t.isFunction(n[e])&&"_"!==e.charAt(0)?(n[e].apply(n,i),s):(n._debug("no such method '"+e+"'"),s):(n._debug("instance is not initialization"),s)})}else this.each(function(){t.data(this,"plugin_"+o)||t.data(this,"plugin_"+o,new n(this,e))});return this}})(jQuery,window,document),function(t,e){"use strict";var i="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";t.fn.imagesLoaded=function(s){function n(){var e=t(u),i=t(g);l&&(g.length?l.reject(A,e,i):l.resolve(A)),t.isFunction(s)&&s.call(r,A,e,i)}function a(t){o(t.target,"error"===t.type)}function o(e,s){e.src!==i&&-1===t.inArray(e,c)&&(c.push(e),s?g.push(e):u.push(e),t.data(e,"imagesLoaded",{isBroken:s,src:e.src}),h&&l.notifyWith(t(e),[s,A,t(u),t(g)]),A.length===c.length&&(setTimeout(n),A.unbind(".imagesLoaded",a)))}var r=this,l=t.isFunction(t.Deferred)?t.Deferred():0,h=t.isFunction(l.notify),A=r.find("img").add(r.filter("img")),c=[],u=[],g=[];return t.isPlainObject(s)&&t.each(s,function(t,e){"callback"===t?s=e:l&&l[t](e)}),A.length?A.bind("load.imagesLoaded error.imagesLoaded",a).each(function(s,n){var a=n.src,r=t.data(n,"imagesLoaded");return r&&r.src===a?(o(n,r.isBroken),e):n.complete&&n.naturalWidth!==e?(o(n,0===n.naturalWidth||0===n.naturalHeight),e):((n.readyState||n.complete)&&(n.src=i,n.src=a),e)}):n(),l?l.promise(r):r}}(jQuery);